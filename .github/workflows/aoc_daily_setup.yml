name: Advent of Code Daily Setup

on:
  # 1. SCHEDULE TRIGGER: Runs daily during the AoC event (Dec 1-12) at 6:00 AM CET (05:00 UTC).
  schedule:
    # 0 5 1-12 12 * -> Minute 0, Hour 5 (UTC) = 6:00 AM CET
    - cron: '0 5 1-12 12 *'

  # 2. MANUAL TRIGGER: Allows testing with fixed day/year from the GitHub Actions UI.
  workflow_dispatch:
    inputs:
      aoc_day:
        description: 'AoC Day (e.g., 3). Leave blank for current day/scheduled run.'
        required: false
        default: ''
      aoc_year:
        description: 'AoC Year (e.g., 2023). Leave blank for current year/scheduled run.'
        required: false
        default: ''

jobs:
  setup_day:
    runs-on: ubuntu-latest

    # Run only if triggered manually OR by schedule.
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Uses the automatic GITHUB_TOKEN to allow pushing the new branch/commit
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17 (Required for modern Gradle/Kotlin)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Gradle Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: Create .env file with AoC Token
        # Reads the securely stored AOC_SESSION_COOKIE secret and writes it to a temporary .env file
        run: echo "AOC_SESSION_COOKIE='${{ secrets.AOC_SESSION_COOKIE }}'" > .env
        shell: bash

      - name: Determine Current Day and Year
        id: date_vars
        run: |
          # The date command provides the current day (DD) and year (YYYY)
          DEFAULT_DAY=$((10#$(date +%d)))
          DEFAULT_YEAR=$(date +%Y)
          
          # Logic to use the manual input if provided, otherwise use the current date
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.aoc_day }}" ]; then
            CURRENT_DAY=$((10#${{ github.event.inputs.aoc_day }}))
          else
            CURRENT_DAY=$DEFAULT_DAY
          fi
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.aoc_year }}" ]; then
            CURRENT_YEAR=${{ github.event.inputs.aoc_year }}
          else
            CURRENT_YEAR=$DEFAULT_YEAR
          fi
          
          # Set variables for use in later steps
          echo "CURRENT_DAY=$CURRENT_DAY" >> $GITHUB_OUTPUT
          echo "CURRENT_YEAR=$CURRENT_YEAR" >> $GITHUB_OUTPUT

      - name: Execute Setup Script and Commit
        run: |
          # Run the external shell script, passing the dynamically determined day and year
          chmod +x scripts/setup.sh
          ./scripts/setup.sh ${{ steps.date_vars.outputs.CURRENT_DAY }} ${{ steps.date_vars.outputs.CURRENT_YEAR }}

      - name: Push the New Branch
        run: |
          # Assemble the branch name (e.g., aoc/2024/03)
          BRANCH_NAME="aoc/${{ steps.date_vars.outputs.CURRENT_YEAR }}/$(printf "%02d" ${{ steps.date_vars.outputs.CURRENT_DAY }})"
          echo "Pushing branch $BRANCH_NAME..."
          # Force push to ensure the branch is created and set as upstream
          git push -u origin $BRANCH_NAME